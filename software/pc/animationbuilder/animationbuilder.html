<!DOCTYPE html>
<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
        <link rel="stylesheet" media="screen" type="text/css" href="colorpicker/css/colorpicker.css" />
        <script type="text/javascript" src="colorpicker/js/colorpicker.js"></script>
        <title>Partyhatwork animation configurator</title>
    </head>
    <body>
        <h1>Partyhatwork animation configurator</h1>
        <!-- TODO: re-enable when we have callback for this that actually works, meanwhile shift-reload works
        <button id="resetbutton">Reset</button>
        -->
        <div id="preview" style="float: left; width: 50%;">
        </div>
        <div id="animationinfo" style="float: right; width: 50%">
            <h2>Animation information</h2>
            Name (valid c++ variable name): <input type="text" name="name" value="my_animation" /> <br/>
            <div id="ledselector" style="float: left; width: 50%">
                <h2>Active LEDs</h2>
                <input type="checkbox" id="led_0_enabled" value="0x1" checked /><label for="led_0_enabled" id="lbl_led_0_enabled"> Left</label><br/>
                <input type="checkbox" id="led_1_enabled" value="0x2" checked /><label for="led_1_enabled" id="lbl_led_1_enabled"> Right</label><br/>
                <input type="checkbox" id="led_2_enabled" value="0x4" /><label for="led_2_enabled" id="lbl_led_2_enabled"> Front</label><br/>
                <input type="checkbox" id="led_3_enabled" value="0x8" /><label for="led_3_enabled" id="lbl_led_3_enabled"> Back</label><br/>
                <input type="checkbox" id="led_4_enabled" value="0x10" /><label for="led_4_enabled" id="lbl_led_4_enabled"> Undef 1</label><br/>
                <input type="checkbox" id="led_5_enabled" value="0x20" /><label for="led_5_enabled" id="lbl_led_5_enabled"> Undef 2</label><br/>
                <input type="checkbox" id="led_6_enabled" value="0x40" /><label for="led_6_enabled" id="lbl_led_6_enabled"> Undef 3</label><br/>
                <input type="checkbox" id="led_7_enabled" value="0x80" /><label for="led_7_enabled" id="lbl_led_7_enabled"> Undef 4</label><br/>
            </div>
            <div id="modes" style="float: right; width: 50%">
                <h3>Mode flags</h3>
                <input type="checkbox" id="mode_fading" value="0x1" checked /><label for="mode_fading" id="lbl_mode_fading"> Fading</label><br/>
            </div>
        </div>
        <div id="framecontainer" style="float: right; width: 50%">
            <table id="frames">
                <thead>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button id="newframe">Add frame</button>
            <button id="previewbutton">Preview</button>
        </div>
        <div id="generated" style="clear: both; height: 200px;">
            <h2>Generated code</h2>
            <textarea name="generated" style="height: 100%; width: 100%"></textarea>
        </div>
        <script type="text/javascript">
            function animation_class() {
                this.state = 'stopped';
                var current_frame = 0;
                var num_frames = 0;

                this.start = function()
                {
                    this.state = 'running';
                    current_frame = 0;
                    num_frames = jQuery('#frames tbody tr').length;
                    setTimeout(run_step, 1);
                }

                this.stop = function()
                {
                    this.state = 'stopped';
                    current_frame = 0;
                }

                var run_step = function()
                {
                    console.log('run_step called');
                }
            };
            animation = new animation_class();

            jQuery(document).ready(function(){
                jQuery('#previewbutton').hide();
                jQuery('#newframe').click(function(){
                    // Disable all the led selectors
                    jQuery('#ledselector input').prop('disabled', true);
                    jQuery('#previewbutton').show();
                    // No header, add it.
                    if (jQuery('#frames thead tr').length == 0)
                    {
                        row1html = '<tr>';
                        for(i=0; i<8; i++)
                        {
                            if (jQuery('#led_'+i+'_enabled').filter(':checked').length)
                            {
                                lbl = jQuery('#lbl_led_'+i+'_enabled')
                                row1html += '<th>'+lbl.html()+'</th>';
                            }
                        }
                        row1html += '<th>Duration (ms)</th></tr>';
                        jQuery('#frames thead').append(row1html);
                    }
                    
                    rows = jQuery('#frames tbody tr').length;
                    // Add the frame values inputs
                    rowhtml = '<tr>';
                    for(i=0; i<8; i++)
                    {
                        if (jQuery('#led_'+i+'_enabled').filter(':checked').length)
                        {
                            rowhtml += '<td><input class="rgbinput" id="row_'+rows+'_led_'+i+'_rbg" name="row_'+rows+'_led_'+i+'_rbg" /></td>';
                        }
                    }
                    rowhtml += '<td class="duration"><input id="row_'+rows+'_duration" /><button class="deleterow">X</button></td></tr>';
                    jQuery('#frames tbody').append(rowhtml);
                    // Initialize colorpicker for inputs
                    jQuery('input.rgbinput').ColorPicker({
                        onSubmit: function(hsb, hex, rgb, el) {
                            jel = jQuery(el);
                            jel.val(hex);
                            jel.css('background-color', '#'+hex);
                            jel.ColorPickerHide();
                        },
                        onBeforeShow: function () {
                            $(this).ColorPickerSetColor(this.value);
                        }
                    });
                    // Row remove callback (TODO: before this we should probably make sure only the last row has the input)
                    jQuery('button.deleterow').click(function(){
                        me = jQuery(this);
                        me.parents('tr').remove();
                        // Re-enable LED selectors when we have no frames
                        if (jQuery('#frames tbody tr').length == 0)
                        {
                            // Remove the header
                            jQuery('#frames thead tr').remove();
                            jQuery('#ledselector input').prop('disabled', false);
                            jQuery('#previewbutton').hide();
                        }
                    });
                    // 
                    jQuery('#previewbutton').click(function(){
                        me = jQuery(this);
                        if (animation.state == 'stopped')
                        {
                            animation.start();
                            me.html('Stop preview');
                            return;
                        }
                        else
                        {
                            animation.stop();
                            me.html('Preview');
                            return;
                        }
                    });
                    
                });
            });
        </script>
        <style type="text/css">
            #frames td, #frames th
            {
                border: 1px solid black;
            }
            #frames tbody td input
            {
                width: 5em;
            }
            #frames tbody td.duration input
            {
                width: 6em;
            }
        </style>
    </body>
</html>
